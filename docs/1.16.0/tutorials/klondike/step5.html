<!DOCTYPE html>
<html lang="en">
<head>
<meta name="robots" content="noindex">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>5. Animations, restarting, buttons and a New World &#8212; Flame</title>
  <!-- Stylesheets -->
  <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b20cc3f5" />
  <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=eeb27264" />
  <link rel="stylesheet" type="text/css" href="../../_static/dart_domain.css" />
  <link rel="stylesheet" type="text/css" href="../../_static/flutter_app.css?v=6984c178" />
  <link rel="stylesheet" type="text/css" href="../../_static/package.css?v=7889e545" />
  <link rel="stylesheet" type="text/css" href="../../_static/yarn_lexer.css?v=932ca0ec" />
  <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
  <link rel="stylesheet" type="text/css" href="../../_static/flames.css?v=ac7bdd72" />
  <link rel="stylesheet" type="text/css" href="../../_static/copy-button.css?v=deecb4da" />
  <!-- Scripts -->
  <script src="../../_static/jquery.js?v=5d32c60e"></script>
  <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
  <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
  <script src="../../_static/doctools.js?v=0b60eaae"></script>
  <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
  <script src="../../_static/flutter_app.js?v=3619378f"></script>
  <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
  <script src="../../_static/copybutton.js?v=f281be69"></script>
  <script src="../../_static/versions.js?v=58484017"></script>
  <script src="../../_static/menu-expand.js?v=8e297497"></script>
  <!--script src="searchindex.js" defer></script-->
  <!-- Links -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:ital,wght@0,400;0,700;1,400;1,700&display=swap">
  <link rel="preload" as="font" type="font/woff2" crossorigin="" href="../../_static/fontawesome/fa-brands-400.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin="" href="../../_static/fontawesome/fa-solid-900.woff2">
  <link rel="stylesheet" href="../../_static/fontawesome/all.min.css">
  <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  <link rel="index" title="Index" href="../../genindex.html" />
  <link rel="search" title="Search" href="../../search.html" />
  <link rel="next" title="Ember Quest Game Tutorial" href="../platformer/platformer.html" />
  <link rel="prev" title="4. Gameplay" href="step4.html" />
</head>

<body data-spy="scroll" data-target="#toc-local" data-offset="80">

<div class="top-bar">
  <button id="menu-button" class="btn" title="Toggle menu"><i class="fa fa-bars"></i></button>
  <script type="text/javascript">
    jQuery(function(){
      $("#menu-button").click(function() {
        $(this).toggleClass("active");
        $(".sidebar-left-area").toggleClass("active");
      });

      $('div.nav-left li > a:not(:only-child)').wrap('<div class=submenu></div>');
      $('div.nav-left div.submenu').prepend('<a class=arrow>&nbsp;</a>');
      $('div.nav-left div.submenu > a.arrow')
        .click(function() {
          $(this.parentElement.parentElement).toggleClass('current');
        });

      // This function ensures that when navigating to internal targets within the page (such as
      // a section header), those targets will be visible to the user and not obscured by the menu
      // bar at the top of the page.
      function scrollToHashTarget() {
        if (location.hash !== location.oldHash) {
          window.scrollBy(0, -60);
          location.oldHash = location.hash;
        }
      }
      window.location.oldHash = '';
      window.addEventListener('hashchange', scrollToHashTarget);
      scrollToHashTarget();
    });
  </script>

  <a href="../../index.html" class="logo_image" aria-label="Navigate to home page">
    <img src="../../_static/logo_flame.png" alt="Flame logo: a fiery symbol along with the FLAME wordmark.">
  </a>  
  <div class="highlight-box" role="alert" style="display:none">
    <div>
      <div class="title">highlighted:</div>
      <div class="content" id="highlight-content"></div>
    </div>
    <button type="button" class="close" data-dismiss="alert" aria-label="Dismiss">×</button>
  </div>
  <div class="expander"></div>

  <div class="versions-placeholder"></div>
  <a href="https://discord.com/invite/pxrBmy4" id="discord-button" class="btn"
     title="Blue Fire Discord server">
    <i class="fab fa-discord"></i>
  </a>
  <a href="https://github.com/flame-engine/flame/" id="github-button" class="btn"
     title="GitHub repository">
    <i class="fab fa-github"></i>
  </a>
</div>

<div class="sidebar-left-area">
  <div class="sidebar-left-bg"></div>
  <div class="sidebar-left">
    <div class="searchbox" role="search">
      <form id="search-form" action="../../search.html" method="get">
        <i class="icon fa fa-search"></i>
        <input type="search" class="form-control" id="search-input" name="q"
               placeholder="Search the docs..." autocomplete="off" />
      </form>
    </div>
    <div class="nav-left" role="navigation" aria-label="Main">
      <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../flame/flame.html">Flame</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../flame/structure.html">File Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../flame/game_widget.html">Game Widget</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../flame/game.html">Game Loop</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../flame/components.html">Components</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../flame/router.html">Router</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../flame/platforms.html">Platforms</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../flame/collision_detection.html">Collision Detection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../flame/effects.html">Effects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../flame/camera_component.html">Camera Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../flame/inputs/inputs.html">Inputs</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../flame/inputs/drag_events.html">Drag Events</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../flame/inputs/gesture_input.html">Gesture Input</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../flame/inputs/keyboard_input.html">Keyboard Input</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../flame/inputs/other_inputs.html">Other Inputs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../flame/inputs/tap_events.html">Tap Events</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../flame/inputs/pointer_events.html">Pointer Events</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../flame/inputs/hardware_keyboard_detector.html">HardwareKeyboardDetector</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../flame/rendering/rendering.html">Rendering</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../flame/rendering/palette.html">Colors and Palette</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../flame/rendering/decorators.html">Decorators</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../flame/rendering/images.html">Images, Sprites and Animations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../flame/rendering/layers.html">Layers and Snapshots</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../flame/rendering/particles.html">Particles</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../flame/rendering/text_rendering.html">Text Rendering</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../flame/layout/layout.html">Layout</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../flame/layout/align_component.html">AlignComponent</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../flame/overlays.html">Overlays</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../flame/other/other.html">Other</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../flame/other/debug.html">Debugging</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../flame/other/util.html">Utils</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../flame/other/widgets.html">Widgets</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../bridge_packages/bridge_packages.html">Bridge Packages</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../bridge_packages/flame_audio/flame_audio.html">flame_audio</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../bridge_packages/flame_audio/audio.html">General audio</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../bridge_packages/flame_audio/bgm.html">Background music</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../bridge_packages/flame_audio/audio_pool.html">AudioPool</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../bridge_packages/flame_bloc/flame_bloc.html">flame_bloc</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../bridge_packages/flame_bloc/bloc.html">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../bridge_packages/flame_bloc/bloc_components.html">Components</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../bridge_packages/flame_fire_atlas/flame_fire_atlas.html">flame_fire_atlas</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../bridge_packages/flame_fire_atlas/fire_atlas.html">Overview</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../bridge_packages/flame_forge2d/flame_forge2d.html">flame_forge2d</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../bridge_packages/flame_forge2d/forge2d.html">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../bridge_packages/flame_forge2d/joints.html">Joints</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../bridge_packages/flame_isolate/flame_isolate.html">flame_isolate</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../bridge_packages/flame_isolate/isolate.html">Overview</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../bridge_packages/flame_lottie/flame_lottie.html">flame_lottie</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../bridge_packages/flame_network_assets/flame_network_assets.html">flame_network_assets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../bridge_packages/flame_oxygen/flame_oxygen.html">flame_oxygen</a><ul class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../bridge_packages/flame_rive/flame_rive.html">flame_rive</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../bridge_packages/flame_rive/rive.html">Overview</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../bridge_packages/flame_riverpod/flame_riverpod.html">flame_riverpod</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../bridge_packages/flame_riverpod/riverpod.html">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../bridge_packages/flame_riverpod/component.html">Component</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../bridge_packages/flame_riverpod/widget.html">Widget</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../bridge_packages/flame_splash_screen/flame_splash_screen.html">flame_splash_screen</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../bridge_packages/flame_spine/flame_spine.html">flame_spine</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../bridge_packages/flame_svg/flame_svg.html">flame_svg</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../bridge_packages/flame_svg/svg.html">Overview</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../bridge_packages/flame_tiled/flame_tiled.html">flame_tiled</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../bridge_packages/flame_tiled/tiled.html">Tiled</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../bridge_packages/flame_tiled/layers.html">Layers</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../other_modules/other_modules.html">Other Modules</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../other_modules/jenny/jenny.html">jenny</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../other_modules/jenny/language/language.html">YarnSpinner language</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../other_modules/jenny/language/nodes.html">Nodes</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../other_modules/jenny/language/lines.html">Lines</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../other_modules/jenny/language/options.html">Options</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../other_modules/jenny/language/commands/commands.html">Commands</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../other_modules/jenny/language/commands/character.html">&lt;&lt;character&gt;&gt;</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../other_modules/jenny/language/commands/declare.html">&lt;&lt;declare&gt;&gt;</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../other_modules/jenny/language/commands/if.html">&lt;&lt;if&gt;&gt;</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../other_modules/jenny/language/commands/jump.html">&lt;&lt;jump&gt;&gt;</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../other_modules/jenny/language/commands/local.html">&lt;&lt;local&gt;&gt;</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../other_modules/jenny/language/commands/set.html">&lt;&lt;set&gt;&gt;</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../other_modules/jenny/language/commands/stop.html">&lt;&lt;stop&gt;&gt;</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../other_modules/jenny/language/commands/visit.html">&lt;&lt;visit&gt;&gt;</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../other_modules/jenny/language/commands/wait.html">&lt;&lt;wait&gt;&gt;</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../other_modules/jenny/language/commands/user_defined_commands.html">User-defined commands</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../other_modules/jenny/language/expressions/expressions.html">Expressions</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../other_modules/jenny/language/expressions/variables.html">Variables</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../other_modules/jenny/language/expressions/operators.html">Operators</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../other_modules/jenny/language/expressions/functions/functions.html">Functions</a><ul>
<li class="toctree-l6"><a class="reference internal" href="../../other_modules/jenny/language/expressions/functions/random.html">Random functions</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../other_modules/jenny/language/expressions/functions/numeric.html">Numeric functions</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../other_modules/jenny/language/expressions/functions/type.html">Type conversion functions</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../other_modules/jenny/language/expressions/functions/misc.html">Miscellaneous functions</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../other_modules/jenny/language/markup.html">Markup</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../other_modules/jenny/runtime/jenny_runtime.html">Jenny API</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../other_modules/jenny/runtime/character.html">Character</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../other_modules/jenny/runtime/character_storage.html">CharacterStorage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../other_modules/jenny/runtime/command_storage.html">CommandStorage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../other_modules/jenny/runtime/dialogue_choice.html">DialogueChoice</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../other_modules/jenny/runtime/dialogue_line.html">DialogueLine</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../other_modules/jenny/runtime/dialogue_option.html">DialogueOption</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../other_modules/jenny/runtime/dialogue_runner.html">DialogueRunner</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../other_modules/jenny/runtime/dialogue_view.html">DialogueView</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../other_modules/jenny/runtime/function_storage.html">FunctionStorage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../other_modules/jenny/runtime/markup_attribute.html">MarkupAttribute</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../other_modules/jenny/runtime/node.html">Node</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../other_modules/jenny/runtime/user_defined_command.html">UserDefinedCommand</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../other_modules/jenny/runtime/variable_storage.html">VariableStorage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../other_modules/jenny/runtime/yarn_project.html">YarnProject</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../other_modules/oxygen/oxygen.html">oxygen</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../other_modules/oxygen/components.html">Components</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../tutorials.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../bare_flame_game.html">Bare Flame game</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="klondike.html">Klondike</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="step1.html">1. Preparation</a></li>
<li class="toctree-l3"><a class="reference internal" href="step2.html">2. Scaffolding</a></li>
<li class="toctree-l3"><a class="reference internal" href="step3.html">3. Cards</a></li>
<li class="toctree-l3"><a class="reference internal" href="step4.html">4. Gameplay</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">5. Additional features</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../platformer/platformer.html">Ember Quest</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../platformer/step_1.html">1. Preparation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../platformer/step_2.html">2. Start Coding</a></li>
<li class="toctree-l3"><a class="reference internal" href="../platformer/step_3.html">3. Building the World</a></li>
<li class="toctree-l3"><a class="reference internal" href="../platformer/step_4.html">4. Adding the Remaining Components</a></li>
<li class="toctree-l3"><a class="reference internal" href="../platformer/step_5.html">5. Controlling Movement</a></li>
<li class="toctree-l3"><a class="reference internal" href="../platformer/step_6.html">6. Adding the HUD</a></li>
<li class="toctree-l3"><a class="reference internal" href="../platformer/step_7.html">7. Adding Menus</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../space_shooter/space_shooter.html">Space Shooter</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../space_shooter/step_1.html">1. Getting Started</a></li>
<li class="toctree-l3"><a class="reference internal" href="../space_shooter/step_2.html">2. Controlling the player and adding some graphics</a></li>
<li class="toctree-l3"><a class="reference internal" href="../space_shooter/step_3.html">3. Adding animations and depth</a></li>
<li class="toctree-l3"><a class="reference internal" href="../space_shooter/step_4.html">4. Adding Bullets</a></li>
<li class="toctree-l3"><a class="reference internal" href="../space_shooter/step_5.html">5. Adding Enemies</a></li>
<li class="toctree-l3"><a class="reference internal" href="../space_shooter/step_6.html">6. Enemy and Bullet collisions</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../development/development.html">Development</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../development/contributing.html">Contributing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../development/documentation.html">Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../development/style_guide.html">Style Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../development/testing_guide.html">Tests Guide</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../resources/resources.html">Resources</a><ul>
<li class="toctree-l2"><a class="reference external" href="https://pub.dev/documentation/flame/1.16.0/">Flame API</a></li>
<li class="toctree-l2"><a class="reference external" href="https://examples.flame-engine.org/#/">Flame Examples</a></li>
</ul>
</li>
</ul>

    </div>
  </div>
</div>

<div class="main-area">
  <div class="document-wrapper">
    <div class="warning hidden" id="version-warning">
      <p><strong>Warning:</strong> you are currently viewing the docs for an older
      version <span class="version"></span> of Flame.</p>
      <p>Please <a href="/">click here</a> to go see the documentation for the latest
      released version.</p>
    </div>
    <div class="document" role="main">
      
  <section class="tex2jax_ignore mathjax_ignore" id="animations-restarting-buttons-and-a-new-world">
<h1>5. Animations, restarting, buttons and a New World<a class="headerlink" href="#animations-restarting-buttons-and-a-new-world" title="Link to this heading">¶</a></h1>
<p>In this chapter we will be showing various ways to make the Klondike game more fun and easier to
play. The topics to be covered are:</p>
<ul class="simple">
<li><p>Klondike Draw 1 and Draw 3</p></li>
<li><p>Animating and automating moves</p></li>
<li><p>Detecting and celebrating a win</p></li>
<li><p>Ending and restarting the game</p></li>
<li><p>How to implement your own FlameGame world</p></li>
<li><p>Simple action-buttons</p></li>
<li><p>Anchors and co-ordinates</p></li>
<li><p>Random number generation and seeding</p></li>
<li><p>Effects and EffectControllers</p></li>
</ul>
<section id="the-klondike-draw">
<h2>The Klondike draw<a class="headerlink" href="#the-klondike-draw" title="Link to this heading">¶</a></h2>
<p>The Klondike patience game (or solitaire game in the USA) has two main variants: Draw 3 and Draw 1.
Currently the Klondike Flame Game is Draw 3, which is a lot more difficult than Draw 1, because
although you can see 3 cards, you can only move one of them and that move changes the “phase” of
other cards. So different cards are going to become available — not easy.</p>
<p>In Klondike Draw 1 just one card at a time is drawn from the Stock and shown, so every card in it is
available, and you can go through the Stock as many times as you like, just as in Klondike Draw 3.</p>
<p>So how do we implement Klondike Draw 1? Clearly only the Stock and Waste piles are involved, so
maybe we should have KlondikeGame provide a value 1 or 3 to each of them. They both have code for
constructors, so we could just add an extra parameter to that code, but in Flame there is another
way, which works even if your component has a default constructor (no code for it) or your game has
many game-wide values. Let us call our value <code class="docutils literal notranslate"><span class="pre">klondikeDraw</span></code>. In your class declaration add the
<code class="docutils literal notranslate"><span class="pre">HasGameReference&lt;MyGame&gt;</span></code> mixin, then write <code class="docutils literal notranslate"><span class="pre">game.klondikeDraw</span></code> wherever you need the value 1 or 3.
For class StockPile we will have:</p>
<div class="highlight-dart notranslate"><div class="highlight"><pre><span></span><span class="kd">class</span><span class="w"> </span><span class="nc">StockPile</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">PositionComponent</span>
<span class="w">    </span><span class="kd">with</span><span class="w"> </span><span class="n">TapCallbacks</span><span class="p">,</span><span class="w"> </span><span class="n">HasGameReference</span><span class="o">&lt;</span><span class="n">KlondikeGame</span><span class="o">&gt;</span>
<span class="w">    </span><span class="kd">implements</span><span class="w"> </span><span class="n">Pile</span><span class="w"> </span><span class="p">{</span>
</pre></div>
</div>
<p>and</p>
<div class="highlight-dart notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="nd">@override</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">onTapUp</span><span class="p">(</span><span class="n">TapUpEvent</span><span class="w"> </span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">wastePile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parent</span><span class="o">!</span><span class="p">.</span><span class="n">firstChild</span><span class="o">&lt;</span><span class="n">WastePile</span><span class="o">&gt;</span><span class="p">()</span><span class="o">!</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_cards</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">wastePile</span><span class="p">.</span><span class="n">removeAllCards</span><span class="p">().</span><span class="n">reversed</span><span class="p">.</span><span class="n">forEach</span><span class="p">((</span><span class="n">card</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">card</span><span class="p">.</span><span class="n">flip</span><span class="p">();</span>
<span class="w">        </span><span class="n">acquireCard</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">klondikeDraw</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_cards</span><span class="p">.</span><span class="n">isNotEmpty</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kd">final</span><span class="w"> </span><span class="n">card</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_cards</span><span class="p">.</span><span class="n">removeLast</span><span class="p">();</span>
<span class="w">          </span><span class="n">card</span><span class="p">.</span><span class="n">flip</span><span class="p">();</span>
<span class="w">          </span><span class="n">wastePile</span><span class="p">.</span><span class="n">acquireCard</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
</pre></div>
</div>
<p>For class WastePile we will have:</p>
<div class="highlight-dart notranslate"><div class="highlight"><pre><span></span><span class="kd">class</span><span class="w"> </span><span class="nc">WastePile</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">PositionComponent</span>
<span class="w">    </span><span class="kd">with</span><span class="w"> </span><span class="n">HasGameReference</span><span class="o">&lt;</span><span class="n">KlondikeGame</span><span class="o">&gt;</span>
<span class="w">    </span><span class="kd">implements</span><span class="w"> </span><span class="n">Pile</span><span class="w"> </span><span class="p">{</span>
</pre></div>
</div>
<p>and</p>
<div class="highlight-dart notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">_fanOutTopCards</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">klondikeDraw</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">   </span><span class="c1">// No fan-out in Klondike Draw 1.</span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_cards</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">_cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">position</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">_cards</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">position</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">_fanOffset</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="m">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">_cards</span><span class="p">[</span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">2</span><span class="p">].</span><span class="n">position</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">_fanOffset</span><span class="p">);</span>
<span class="w">      </span><span class="n">_cards</span><span class="p">[</span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">].</span><span class="n">position</span><span class="p">.</span><span class="n">addScaled</span><span class="p">(</span><span class="n">_fanOffset</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
</pre></div>
</div>
<p>That makes the Stock and Waste piles play either Klondike Draw 1 or Klondike Draw 3, but how do you
tell them which variant to play? For now, we will add a place-holder to the KlondikeGame class.
We just comment out whichever one we do not want and then rebuild.</p>
<div class="highlight-dart notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c1">// final int klondikeDraw = 3;</span>
<span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">klondikeDraw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">;</span>
</pre></div>
</div>
<p>This is fine as a temporary measure, when we have not yet decided how to handle some aspect of
our design, but ultimately we will have to provide some kind of <strong>input</strong> for the player to choose
which flavor of Klondike to play, such as a menu screen, a settings screen or a button. Flame can
incorporate Flutter widgets into a game and the next Tutorial (Ember) shows how to add a menu
widget, as its final step.</p>
</section>
<section id="making-cards-move">
<h2>Making cards move<a class="headerlink" href="#making-cards-move" title="Link to this heading">¶</a></h2>
<p>In Flame, if we need a component to do something, we use an <code class="docutils literal notranslate"><span class="pre">Effect</span></code> - a special component that can
attach to another component, such as a card, and modify its properties. That includes any kind of
motion (or change of <code class="docutils literal notranslate"><span class="pre">position</span></code>). We also need an <code class="docutils literal notranslate"><span class="pre">EffectController</span></code>, which provides timing for an
effect: when to start, how long to go for and what <code class="docutils literal notranslate"><span class="pre">Curve</span></code> to follow. The latter is not a curve in
space. It is a time-curve that specifies accelerations and decelerations during the time of the
effect, such as start moving a card quickly and then slow down as it approaches its destination.</p>
<p>To move a card, we will add a <code class="docutils literal notranslate"><span class="pre">doMove()</span></code> method to the <code class="docutils literal notranslate"><span class="pre">Card</span></code> class. It will require a <code class="docutils literal notranslate"><span class="pre">to</span></code> location
to go to. Optional parameters are <code class="docutils literal notranslate"><span class="pre">speed:</span></code> (default 10.0), <code class="docutils literal notranslate"><span class="pre">start:</span></code> (default zero),
<code class="docutils literal notranslate"><span class="pre">curve:</span></code> (default <code class="docutils literal notranslate"><span class="pre">Curves.easeOutQuad</span></code>) and <code class="docutils literal notranslate"><span class="pre">onComplete:</span></code> (default <code class="docutils literal notranslate"><span class="pre">null</span></code>, i.e. no callback when
the move finishes). Speed is in card widths per second. Usually we will provide a callback, because
a bit of gameplay must be done <strong>after</strong> the animated move. The default <code class="docutils literal notranslate"><span class="pre">curve:</span></code> parameter gives us
a fast-in/slow-out move, much as a human player would do. So the following code is added to the
end of the <code class="docutils literal notranslate"><span class="pre">Card</span></code> class:</p>
<div class="highlight-dart notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">doMove</span><span class="p">(</span>
<span class="w">    </span><span class="n">Vector2</span><span class="w"> </span><span class="n">to</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">speed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10.0</span><span class="p">,</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.0</span><span class="p">,</span>
<span class="w">    </span><span class="n">Curve</span><span class="w"> </span><span class="n">curve</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Curves</span><span class="p">.</span><span class="n">easeOutQuad</span><span class="p">,</span>
<span class="w">    </span><span class="n">VoidCallback</span><span class="o">?</span><span class="w"> </span><span class="n">onComplete</span><span class="p">,</span>
<span class="w">  </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">assert</span><span class="p">(</span><span class="n">speed</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0.0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Speed must be &gt; 0 widths per second&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">to</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">position</span><span class="p">).</span><span class="n">length</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">speed</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
<span class="w">    </span><span class="k">assert</span><span class="p">(</span><span class="n">dt</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0.0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Distance to move must be &gt; 0&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="n">priority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">100</span><span class="p">;</span>
<span class="w">    </span><span class="n">add</span><span class="p">(</span>
<span class="w">      </span><span class="n">MoveToEffect</span><span class="p">(</span>
<span class="w">        </span><span class="n">to</span><span class="p">,</span>
<span class="w">        </span><span class="n">EffectController</span><span class="p">(</span><span class="nl">duration:</span><span class="w"> </span><span class="n">dt</span><span class="p">,</span><span class="w"> </span><span class="nl">startDelay:</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="nl">curve:</span><span class="w"> </span><span class="n">curve</span><span class="p">),</span>
<span class="w">        </span><span class="nl">onComplete:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="n">onComplete</span><span class="o">?</span><span class="p">.</span><span class="n">call</span><span class="p">();</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">      </span><span class="p">),</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
</pre></div>
</div>
<p>To make this code compile we need to import <code class="docutils literal notranslate"><span class="pre">'package:flame/effects.dart'</span></code> and
<code class="docutils literal notranslate"><span class="pre">'package:flutter/animation.dart'</span></code> at the top of the <code class="docutils literal notranslate"><span class="pre">components/card.dart</span></code> file. That done, we can
start using the new method to return the card(s) gracefully to where they came from, after being
dropped in an invalid position. First, we need a private data item to store a card’s position when
a drag-and-drop started. So let us insert new lines in two places as shown below:</p>
<div class="highlight-dart notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">_isDragging</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">  </span><span class="n">Vector2</span><span class="w"> </span><span class="n">_whereCardStarted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Vector2</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">);</span>

<span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Card</span><span class="o">&gt;</span><span class="w"> </span><span class="n">attachedCards</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
</pre></div>
</div>
<div class="highlight-dart notranslate"><div class="highlight"><pre><span></span><span class="w">      </span><span class="n">_isDragging</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">      </span><span class="n">priority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">100</span><span class="p">;</span>
<span class="w">      </span><span class="c1">// Copy each co-ord, else _whereCardStarted changes as the position does.</span>
<span class="w">      </span><span class="n">_whereCardStarted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Vector2</span><span class="p">(</span><span class="n">position</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">position</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pile</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">TableauPile</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</pre></div>
</div>
<p>It would be a mistake to write <code class="docutils literal notranslate"><span class="pre">_whereCardStarted</span> <span class="pre">=</span> <span class="pre">position;</span></code> here. In Dart, that would just
copy a reference: so <code class="docutils literal notranslate"><span class="pre">_whereCardStarted</span></code> would point to the same data as <code class="docutils literal notranslate"><span class="pre">position</span></code> while the
drag occurred and the card’s <code class="docutils literal notranslate"><span class="pre">position</span></code> data changed. We can get around this by copying the card’s
<strong>current</strong> X and Y co-ordinates into a <strong>new</strong> <code class="docutils literal notranslate"><span class="pre">Vector2</span></code> object.</p>
<p>To animate cards being returned to their original piles after an invalid drag-and-drop, we replace
five lines at the end of the <code class="docutils literal notranslate"><span class="pre">onDragEnd()</span></code> method with:</p>
<div class="highlight-dart notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="c1">// Invalid drop (middle of nowhere, invalid pile or invalid card for pile).</span>
<span class="w">    </span><span class="n">doMove</span><span class="p">(</span>
<span class="w">      </span><span class="n">_whereCardStarted</span><span class="p">,</span>
<span class="w">      </span><span class="nl">onComplete:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pile</span><span class="o">!</span><span class="p">.</span><span class="n">returnCard</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">attachedCards</span><span class="p">.</span><span class="n">isNotEmpty</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">attachedCards</span><span class="p">.</span><span class="n">forEach</span><span class="p">((</span><span class="n">card</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">card</span><span class="p">.</span><span class="n">position</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">position</span><span class="p">;</span>
<span class="w">        </span><span class="n">card</span><span class="p">.</span><span class="n">doMove</span><span class="p">(</span>
<span class="w">          </span><span class="n">_whereCardStarted</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span>
<span class="w">          </span><span class="nl">onComplete:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">pile</span><span class="o">!</span><span class="p">.</span><span class="n">returnCard</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="w">          </span><span class="p">},</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span><span class="n">attachedCards</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
</div>
<p>In each case, we use the default speed of 10 card-widths per second.
Notice how the <code class="docutils literal notranslate"><span class="pre">onComplete:</span></code> parameters are used to return each card to the pile where it started.
It will then be added back to that pile’s list of contents. Notice also that the list of attached
cards (if any) is cleared immediately, as the animated cards start to move. This does not matter,
because each moving card has a <code class="docutils literal notranslate"><span class="pre">MoveToEffect</span></code> and an <code class="docutils literal notranslate"><span class="pre">EffectController</span></code> added to it and these
contain all the data needed to get the right card to the right place at the right time. Thus
no important information is lost by clearing the attached cards early. Also, by default, the
<code class="docutils literal notranslate"><span class="pre">MoveToEffect</span></code> and <code class="docutils literal notranslate"><span class="pre">EffectController</span></code> in each moving card automatically get detached and deleted
by Flame when the show is over.</p>
<p>Some other automatic and animated moves we can try are dealing the cards, flipping cards from Stock
to Waste pile, turning cards over automatically on the tableau piles, and settling cards into place
after a valid drag-and-drop. We will have a look at animating a flip first.</p>
</section>
<section id="animating-a-card-flip">
<h2>Animating a card-flip<a class="headerlink" href="#animating-a-card-flip" title="Link to this heading">¶</a></h2>
<p>Flutter and Flame do not yet support 3-D effects (as at October 2023), but we can emulate them.
To make a card look as if it is turning over, we will shrink the width of the back-view, switch
to the front view and expand back to full width. The code uses quite a few features of Effects
and EffectControllers:</p>
<div class="highlight-dart notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">turnFaceUp</span><span class="p">({</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.3</span><span class="p">,</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.0</span><span class="p">,</span>
<span class="w">    </span><span class="n">VoidCallback</span><span class="o">?</span><span class="w"> </span><span class="n">onComplete</span><span class="p">,</span>
<span class="w">  </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">assert</span><span class="p">(</span><span class="o">!</span><span class="n">_isFaceUpView</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Card must be face-down before turning face-up.&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">assert</span><span class="p">(</span><span class="n">time</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0.0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Time to turn card over must be &gt; 0&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="n">_isAnimatedFlip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">    </span><span class="n">anchor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Anchor</span><span class="p">.</span><span class="n">topCenter</span><span class="p">;</span>
<span class="w">    </span><span class="n">position</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">Vector2</span><span class="p">(</span><span class="n">width</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">);</span>
<span class="w">    </span><span class="n">priority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">100</span><span class="p">;</span>
<span class="w">    </span><span class="n">add</span><span class="p">(</span>
<span class="w">      </span><span class="n">ScaleEffect</span><span class="p">.</span><span class="n">to</span><span class="p">(</span>
<span class="w">        </span><span class="n">Vector2</span><span class="p">(</span><span class="n">scale</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">100</span><span class="p">,</span><span class="w"> </span><span class="n">scale</span><span class="p">.</span><span class="n">y</span><span class="p">),</span>
<span class="w">        </span><span class="n">EffectController</span><span class="p">(</span>
<span class="w">          </span><span class="nl">startDelay:</span><span class="w"> </span><span class="n">start</span><span class="p">,</span>
<span class="w">          </span><span class="nl">curve:</span><span class="w"> </span><span class="n">Curves</span><span class="p">.</span><span class="n">easeOutSine</span><span class="p">,</span>
<span class="w">          </span><span class="nl">duration:</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">2</span><span class="p">,</span>
<span class="w">          </span><span class="nl">onMax:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">_isFaceUpView</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">          </span><span class="p">},</span>
<span class="w">          </span><span class="nl">reverseDuration:</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">2</span><span class="p">,</span>
<span class="w">          </span><span class="nl">onMin:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">_isAnimatedFlip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">            </span><span class="n">_faceUp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">            </span><span class="n">anchor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Anchor</span><span class="p">.</span><span class="n">topLeft</span><span class="p">;</span>
<span class="w">            </span><span class="n">position</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">Vector2</span><span class="p">(</span><span class="n">width</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">);</span>
<span class="w">          </span><span class="p">},</span>
<span class="w">        </span><span class="p">),</span>
<span class="w">        </span><span class="nl">onComplete:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="n">onComplete</span><span class="o">?</span><span class="p">.</span><span class="n">call</span><span class="p">();</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">      </span><span class="p">),</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
</pre></div>
</div>
<p>So how does all this work? We have a default time of 0.3 seconds for the flip to occur, a start time
and an optional callback on completion, as before. Now we add a ScaleEffect to the card,
which shrinks it almost to zero width, but leaves the height unchanged. However, that must take
only half the time, then we must switch from the face-down to the face-up view of the card and
expand it back out, also in half the time.</p>
<p>This is where we use some of the fancier parameters of the <code class="docutils literal notranslate"><span class="pre">EffectController</span></code> class. The
<code class="docutils literal notranslate"><span class="pre">duration:</span></code> is set to <code class="docutils literal notranslate"><span class="pre">time</span> <span class="pre">/</span> <span class="pre">2</span></code> and we use an <code class="docutils literal notranslate"><span class="pre">onMax:</span></code> callback, with inline code to change the
view to face-up. That callback will happen after <code class="docutils literal notranslate"><span class="pre">time</span> <span class="pre">/</span> <span class="pre">2</span></code>, when the <code class="docutils literal notranslate"><span class="pre">Effect</span></code> (whatever it is)
has reached its maximum (i.e. in this case, the view of the card has shrunk to a thin vertical
line). After the switch to face-up view, the EffectController will take the Effect into reverse
for <code class="docutils literal notranslate"><span class="pre">reverseDuration:</span> <span class="pre">time</span> <span class="pre">/</span> <span class="pre">2</span></code>. Everything is reversed: the view of the card expands and the
<code class="docutils literal notranslate"><span class="pre">curve:</span></code> of time is applied in reverse order. In total, the timing follows a sine curve from
0 to pi, giving a smooth animation in which the width of the card-view is always the projection
into 2-D of its 3-D position. Wow! That’s a lot of work for a little EffectController!</p>
<p>We are not there yet! If you were to run just the <code class="docutils literal notranslate"><span class="pre">add()</span></code> part of the code, you would see some
ugly things happening. Yeah, yeah, been there, done that — when I was preparing this code!
First off, the card shrinks to a line at its left. That is because all cards in this game have
an <code class="docutils literal notranslate"><span class="pre">Anchor</span></code> at <code class="docutils literal notranslate"><span class="pre">topLeft</span></code>, which is the point used to set the card’s <code class="docutils literal notranslate"><span class="pre">position</span></code>. We would like
the card to flip around its vertical center-line. Easy, just set <code class="docutils literal notranslate"><span class="pre">anchor</span> <span class="pre">=</span> <span class="pre">Anchor.topCenter</span></code>
first: that makes the card flip realistically, but it jumps by half a card-width to the left
before flipping.</p>
<p>Long story short, see the lines between <code class="docutils literal notranslate"><span class="pre">assert(</span></code> and <code class="docutils literal notranslate"><span class="pre">add(</span></code> and their reversal in the <code class="docutils literal notranslate"><span class="pre">onMin:</span></code>
callback, which occurs when the Effect is finished, but before the final <code class="docutils literal notranslate"><span class="pre">onComplete:</span></code> callback.
At the beginning, the card’s rendering <code class="docutils literal notranslate"><span class="pre">priority</span></code> is set to 100, so that it will ride above all
other cards in the neighborhood. That value cannot always be saved and restored because we may
not know what the card’s priority should be in whatever <code class="docutils literal notranslate"><span class="pre">Pile</span></code> is receiving it. So we have made
sure that the receiver is always called in the <code class="docutils literal notranslate"><span class="pre">onComplete:</span></code> option, using a method that will
adjust the positions and priorities of the cards in the pile.</p>
<p>Last but not least, in the preceding code, notice the use of the variable <code class="docutils literal notranslate"><span class="pre">_isAnimatedFlip</span></code>.
This is a <code class="docutils literal notranslate"><span class="pre">bool</span></code> variable defined and initialized near the start of class <code class="docutils literal notranslate"><span class="pre">Card</span></code> in file
<code class="docutils literal notranslate"><span class="pre">components/card.dart</span></code>, along with another new <code class="docutils literal notranslate"><span class="pre">bool</span></code> called <code class="docutils literal notranslate"><span class="pre">_isFaceUpView</span></code>. Initially these
are set <code class="docutils literal notranslate"><span class="pre">false</span></code>, along with the existing <code class="docutils literal notranslate"><span class="pre">bool</span> <span class="pre">_faceUp</span> <span class="pre">=</span> <span class="pre">false</span></code> variable. What is the significance
of these variables? It is <strong>huge</strong>. A few lines further down, we see:</p>
<div class="highlight-dart notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="nd">@override</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">render</span><span class="p">(</span><span class="n">Canvas</span><span class="w"> </span><span class="n">canvas</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_isFaceUpView</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">_renderFront</span><span class="p">(</span><span class="n">canvas</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">_renderBack</span><span class="p">(</span><span class="n">canvas</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
</pre></div>
</div>
<p>This is the code that makes every card visible on the screen, in either face-up or face-down state.
At the end of Klondike Tutorial Step 4, the <code class="docutils literal notranslate"><span class="pre">if</span></code> statement was <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">(_faceUp)</span> <span class="pre">{</span></code>. This was OK
because all moves of cards were instantaneous (leaving aside drags and drops): any change in the
card’s face-up or face-down state could be rendered at the Flame Engine’s next <code class="docutils literal notranslate"><span class="pre">tick</span></code> or soon after.
This posed no problem when we started to animate card moves, provided there were no flips involved.
However, when we tapped a non-empty Stock Pile, the executed code was:</p>
<div class="highlight-dart notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="n">card</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_cards</span><span class="p">.</span><span class="n">removeLast</span><span class="p">();</span>
<span class="w">  </span><span class="n">card</span><span class="p">.</span><span class="n">flip</span><span class="p">;</span>
<span class="w">  </span><span class="n">wastePile</span><span class="p">.</span><span class="n">acquireCard</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
</pre></div>
</div>
<p>And the first thing <code class="docutils literal notranslate"><span class="pre">wastePile.acquireCard(</span></code> does is <code class="docutils literal notranslate"><span class="pre">assert(card.isFaceUp);</span></code>, which fails if an
animated flip is keeping the card face-down while the first half of the flip is occurring.</p>
</section>
<section id="model-and-view">
<h2>Model and View<a class="headerlink" href="#model-and-view" title="Link to this heading">¶</a></h2>
<p>Clearly the card cannot be in two states at once: it is not Schrödinger’s cat! We can resolve the
dilemma by using two definitions of “face-up”: a Model type and a View type. The View version is
used in rendering and animation (i.e. what appears on the screen) and the Model version in the logic
of the game, the gameplay and its error-checks. That way, we do not have to revise all the logic
of the Piles in this game in order to animate some of it. A more complex game might benefit from
separating the Model and the View during the design and early coding stages — even into
separate classes. In this game we are using just a little separation of Model and View. The
<code class="docutils literal notranslate"><span class="pre">_isAnimatedFlip</span></code> variable is <code class="docutils literal notranslate"><span class="pre">true</span></code> while there is an animated flip going on, otherwise <code class="docutils literal notranslate"><span class="pre">false</span></code>,
and the <code class="docutils literal notranslate"><span class="pre">Card</span></code> class’s <code class="docutils literal notranslate"><span class="pre">flip()</span></code> function is expanded to:</p>
<div class="highlight-dart notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">flip</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_isAnimatedFlip</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Let the animation determine the FaceUp/FaceDown state.</span>
<span class="w">      </span><span class="n">_faceUp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_isFaceUpView</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// No animation: flip and render the card immediately.</span>
<span class="w">      </span><span class="n">_faceUp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="n">_faceUp</span><span class="p">;</span>
<span class="w">      </span><span class="n">_isFaceUpView</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_faceUp</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
</pre></div>
</div>
<p>In the Klondike Tutorial game we are still having to trigger a Model update in the <code class="docutils literal notranslate"><span class="pre">onComplete:</span></code>
callback of the flip animation. It might be nice, for impatient or rapid-fingered players, to
transfer a card from Stock Pile to Waste Pile instantaneously, in the Model, leaving the animation
in the View to catch up later, with no <code class="docutils literal notranslate"><span class="pre">onComplete:</span></code> callback. That way, you could flip through
the Stock Pile very rapidly, by tapping fast. However, that is beyond the scope of this Tutorial.</p>
</section>
<section id="ending-and-restarting-the-game">
<h2>Ending and restarting the game<a class="headerlink" href="#ending-and-restarting-the-game" title="Link to this heading">¶</a></h2>
<p>As it stands, there is no easy way to finish the Klondike Tutorial game and start another, even if
you have won. We can only close the app and start it again. And there is no “reward” for winning.</p>
<p>There are various ways to tackle this, depending on the simplicity or complexity of your game and
on how long the <code class="docutils literal notranslate"><span class="pre">onLoad()</span></code> method is likely to take. They can range from writing your own
GameWidget, to doing a few simple re-initializations in your Game class (i.e. KlondikeGame in this
case).</p>
<p>In the GameWidget case you would supply the Game with a VoidCallback function parameter named
<code class="docutils literal notranslate"><span class="pre">reset</span></code> or <code class="docutils literal notranslate"><span class="pre">restart</span></code>. When the callback is invoked, it would use the Flutter conventions of a
<code class="docutils literal notranslate"><span class="pre">StatefulWidget</span></code> (e.g. <code class="docutils literal notranslate"><span class="pre">setState(()</span> <span class="pre">{});)</span></code> to force the widget to be rebuilt and replaced, thus
releasing all references to the current Game instance, its state and all of its memory. There could
also be Flutter code to run a menu or other startup screen.</p>
<p>Re-initialization should be undertaken only if the operations involved are few and simple. Otherwise
coding errors could lead to subtle problems, memory leaks and crashes in your game. It might be the
easiest way to go in Klondike (as it is in the Ember Tutorial). Basically, we must clear all the
card references out of all the <code class="docutils literal notranslate"><span class="pre">Pile</span></code>s and then re-shuffle (or not) and re-deal, possibly changing
from Klondike Draw 3 to Klondike Draw 1 or vice-versa.</p>
<p>Well, that was not as easy as it looked! Re-initializing the <code class="docutils literal notranslate"><span class="pre">Pile</span></code>s and each <code class="docutils literal notranslate"><span class="pre">Card</span></code> was easy
enough, but the difficult bit came next… Whether the player wins or restarts without winning, we
have 52 cards spread around various piles on the screen, some face-up and maybe some face-down. We
would like to animate the deal later, so it would be nice to collect the cards into a neat face-down
pile at top left, in the Stock Pile area: not the actual Stock Pile yet, because that gets created
during the deal.</p>
<p>Writing a simple little loop to set each <code class="docutils literal notranslate"><span class="pre">Card</span></code> face-down and use its <code class="docutils literal notranslate"><span class="pre">doMove</span></code> method to make it
move independently to the top left fails. It causes one of those “subtle problems” referred to
earlier. The cards all travel at the same speed but arrive at different times. The deal then
produces messy Tableau Piles with several cards out of position. Also the animated move of all
the cards to the Stock Pile area was a bit ugly.</p>
<p>The problem of the messy Tableau Piles was fixable, but at this point the reviewer of the code
and documentation proposed a completely new approach which avoids re-initializing anything and
creates all the Components from scratch, which is the preferred Flutter/Flame way of doing things.</p>
</section>
<section id="a-new-world">
<h2>A New World<a class="headerlink" href="#a-new-world" title="Link to this heading">¶</a></h2>
<section id="start-and-restart-actions">
<h3>Start and restart actions<a class="headerlink" href="#start-and-restart-actions" title="Link to this heading">¶</a></h3>
<p>We wish to provide the following actions in the Klondike game:</p>
<ul class="simple">
<li><p>A first start,</p></li>
<li><p>Any number of restarts with a new deal,</p></li>
<li><p>Any number of restarts with the same deal as before,</p></li>
<li><p>A switch between Klondike Draw 1 and Draw 3 and restart with a new deal, and</p></li>
<li><p>Have fun before restarting with a new deal (we’ll keep that as a surprise for later).</p></li>
</ul>
<p>The proposal is to have a new KlondikeWorld class, which replaces the default <code class="docutils literal notranslate"><span class="pre">world</span></code> provided by
FlameGame. The new world contains (almost) everything we need to play the game and is created or
re-created during each of the above actions.</p>
</section>
<section id="a-stripped-down-klondikegame-class">
<h3>A stripped-down KlondikeGame class<a class="headerlink" href="#a-stripped-down-klondikegame-class" title="Link to this heading">¶</a></h3>
<p>Here is the new code for the KlondikeGame class (what is left of it).</p>
<div class="highlight-dart notranslate"><div class="highlight"><pre><span></span><span class="n">enum</span><span class="w"> </span><span class="n">Action</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">newDeal</span><span class="p">,</span><span class="w"> </span><span class="n">sameDeal</span><span class="p">,</span><span class="w"> </span><span class="n">changeDraw</span><span class="p">,</span><span class="w"> </span><span class="n">haveFun</span><span class="w"> </span><span class="p">}</span>

<span class="kd">class</span><span class="w"> </span><span class="nc">KlondikeGame</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">FlameGame</span><span class="o">&lt;</span><span class="n">KlondikeWorld</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">cardGap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">175.0</span><span class="p">;</span>
<span class="w">  </span><span class="kd">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">topGap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">500.0</span><span class="p">;</span>
<span class="w">  </span><span class="kd">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">cardWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1000.0</span><span class="p">;</span>
<span class="w">  </span><span class="kd">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">cardHeight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1400.0</span><span class="p">;</span>
<span class="w">  </span><span class="kd">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">cardRadius</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">100.0</span><span class="p">;</span>
<span class="w">  </span><span class="kd">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">cardSpaceWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cardWidth</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cardGap</span><span class="p">;</span>
<span class="w">  </span><span class="kd">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">cardSpaceHeight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cardHeight</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cardGap</span><span class="p">;</span>
<span class="w">  </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Vector2</span><span class="w"> </span><span class="n">cardSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Vector2</span><span class="p">(</span><span class="n">cardWidth</span><span class="p">,</span><span class="w"> </span><span class="n">cardHeight</span><span class="p">);</span>
<span class="w">  </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">cardRRect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RRect</span><span class="p">.</span><span class="n">fromRectAndRadius</span><span class="p">(</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">Rect</span><span class="p">.</span><span class="n">fromLTWH</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">cardWidth</span><span class="p">,</span><span class="w"> </span><span class="n">cardHeight</span><span class="p">),</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">Radius</span><span class="p">.</span><span class="n">circular</span><span class="p">(</span><span class="n">cardRadius</span><span class="p">),</span>
<span class="w">  </span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Constant used when creating Random seed.</span>
<span class="w">  </span><span class="kd">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">maxInt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xFFFFFFFE</span><span class="p">;</span><span class="w"> </span><span class="c1">// = (2 to the power 32) - 1</span>

<span class="w">  </span><span class="c1">// This KlondikeGame constructor also initiates the first KlondikeWorld.</span>
<span class="w">  </span><span class="n">KlondikeGame</span><span class="p">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">super</span><span class="p">(</span><span class="nl">world:</span><span class="w"> </span><span class="n">KlondikeWorld</span><span class="p">());</span>

<span class="w">  </span><span class="c1">// These three values persist between games and are starting conditions</span>
<span class="w">  </span><span class="c1">// for the next game to be played in KlondikeWorld. The actual seed is</span>
<span class="w">  </span><span class="c1">// computed in KlondikeWorld but is held here in case the player chooses</span>
<span class="w">  </span><span class="c1">// to replay a game by selecting Action.sameDeal.</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">klondikeDraw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">;</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">seed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">;</span>
<span class="w">  </span><span class="n">Action</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Action</span><span class="p">.</span><span class="n">newDeal</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Huh! What happened to the <code class="docutils literal notranslate"><span class="pre">onLoad()</span></code> method? And what’s this <code class="docutils literal notranslate"><span class="pre">seed</span></code> thing? And how does
KlondikeWorld get into the act? Well, everything that used to be in the <code class="docutils literal notranslate"><span class="pre">onLoad()</span></code> method is now
in the <code class="docutils literal notranslate"><span class="pre">onLoad()</span></code> method of KlondikeWorld, which is an extension of the <code class="docutils literal notranslate"><span class="pre">World</span></code> class and is a type
of <code class="docutils literal notranslate"><span class="pre">Component</span></code>, so it can have an <code class="docutils literal notranslate"><span class="pre">onLoad()</span></code> method, as can any <code class="docutils literal notranslate"><span class="pre">Component</span></code> type. The content of
the method is much the same as before, except that <code class="docutils literal notranslate"><span class="pre">world.add(</span></code> becomes just <code class="docutils literal notranslate"><span class="pre">add(</span></code>. It also brings
in some <code class="docutils literal notranslate"><span class="pre">addButton()</span></code> references, but more on these later.</p>
</section>
<section id="using-a-random-number-generator-seed">
<h3>Using a Random Number Generator seed<a class="headerlink" href="#using-a-random-number-generator-seed" title="Link to this heading">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">seed</span></code> is a common games-programming technique in any programming environment. Usually it allows
you to start a Random Number Generator from a known point (called the seed) and give your game
reproducible behavior when you are in the development and testing stage. Here it is used to
provide exactly the same deal of the Klondike cards when the player requests <code class="docutils literal notranslate"><span class="pre">Same</span> <span class="pre">deal</span></code>.</p>
</section>
<section id="introducing-the-new-klondikeworld-class">
<h3>Introducing the new KlondikeWorld class<a class="headerlink" href="#introducing-the-new-klondikeworld-class" title="Link to this heading">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">class</span> <span class="pre">KlondikeGame</span></code> declaration specifies that this extension of the FlameGame class must
have a world of type KlondikeWorld (i.e. <code class="docutils literal notranslate"><span class="pre">FlameGame&lt;KlondikeWorld&gt;</span></code>). Didn’t know we could do
that for a game, did we? So how does the first instance of KlondikeWorld get created? It’s all in
the KlondikeGame constructor code:</p>
<div class="highlight-dart notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="n">KlondikeGame</span><span class="p">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">super</span><span class="p">(</span><span class="nl">world:</span><span class="w"> </span><span class="n">KlondikeWorld</span><span class="p">());</span>
</pre></div>
</div>
<p>The constructor itself is a default constructor, but the colon <code class="docutils literal notranslate"><span class="pre">:</span></code> begins a constructor
initialization sequence which creates our world for the first time.</p>
</section>
<section id="buttons">
<h3>Buttons<a class="headerlink" href="#buttons" title="Link to this heading">¶</a></h3>
<p>We are going to use some buttons to activate the various ways of restarting the Klondike Game. First
we extend Flame’s <code class="docutils literal notranslate"><span class="pre">ButtonComponent</span></code> to create class <code class="docutils literal notranslate"><span class="pre">FlatButton</span></code>, adapted from a Flat Button which
used to be in Flame’s Examples pages. <code class="docutils literal notranslate"><span class="pre">ButtonComponent</span></code> uses two <code class="docutils literal notranslate"><span class="pre">PositionComponent</span></code>s, one for when
the button is in its normal state (up) and one for when it is pressed. The two components are
<code class="docutils literal notranslate"><span class="pre">mounted</span></code> and <code class="docutils literal notranslate"><span class="pre">rendered</span></code> alternately as the user presses the button and releases it. To press the
button, tap and hold it down.</p>
<p>In our button, the two components are the button’s outlines - the <code class="docutils literal notranslate"><span class="pre">buttonDown:</span></code> one makes
the outline of the button turn red when it is pressed, as a warning, because the four button-actions
all end the current game and start another. That is also why they are positioned at the top of the
canvas, above all the cards, where you are less likely to press them accidentally. If you do press
one and have second thoughts, keep pressing and slide away, then the button will have no effect.</p>
<p>The four buttons trigger the restart actions described above and are labelled <code class="docutils literal notranslate"><span class="pre">New</span> <span class="pre">deal</span></code>,
<code class="docutils literal notranslate"><span class="pre">Same</span> <span class="pre">deal</span></code>, <code class="docutils literal notranslate"><span class="pre">Draw</span> <span class="pre">1</span> <span class="pre">⇌</span> <span class="pre">3</span></code> and <code class="docutils literal notranslate"><span class="pre">Have</span> <span class="pre">fun</span></code>. Flame also has a <code class="docutils literal notranslate"><span class="pre">SpriteButtonComponent</span></code>, based on two
alternating <code class="docutils literal notranslate"><span class="pre">Sprite</span></code>s, a <code class="docutils literal notranslate"><span class="pre">HudButtonComponent</span></code> and an <code class="docutils literal notranslate"><span class="pre">AdvancedButtonComponent</span></code>. For further types
of buttons and controllers, it would be best to use a Flutter overlay, menu or settings widget and
have access to Flutter’s widgets for radio buttons, dropdown lists, sliders, etc. For the purposes
of this Tutorial our FlatButton will do fine.</p>
<p>We use the <code class="docutils literal notranslate"><span class="pre">addButton()</span></code> method, during our world’s <code class="docutils literal notranslate"><span class="pre">onLoad()</span></code>, to set up our four buttons and
add them to our <code class="docutils literal notranslate"><span class="pre">world</span></code>.</p>
<div class="highlight-dart notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">playAreaSize</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">Vector2</span><span class="p">(</span><span class="m">7</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cardSpaceWidth</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cardGap</span><span class="p">,</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cardSpaceHeight</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">topGap</span><span class="p">);</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">gameMidX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">playAreaSize</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">2</span><span class="p">;</span>

<span class="w">    </span><span class="n">addButton</span><span class="p">(</span><span class="s1">&#39;New deal&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">gameMidX</span><span class="p">,</span><span class="w"> </span><span class="n">Action</span><span class="p">.</span><span class="n">newDeal</span><span class="p">);</span>
<span class="w">    </span><span class="n">addButton</span><span class="p">(</span><span class="s1">&#39;Same deal&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">gameMidX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cardSpaceWidth</span><span class="p">,</span><span class="w"> </span><span class="n">Action</span><span class="p">.</span><span class="n">sameDeal</span><span class="p">);</span>
<span class="w">    </span><span class="n">addButton</span><span class="p">(</span><span class="s1">&#39;Draw 1 or 3&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">gameMidX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cardSpaceWidth</span><span class="p">,</span><span class="w"> </span><span class="n">Action</span><span class="p">.</span><span class="n">changeDraw</span><span class="p">);</span>
<span class="w">    </span><span class="n">addButton</span><span class="p">(</span><span class="s1">&#39;Have fun&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">gameMidX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cardSpaceWidth</span><span class="p">,</span><span class="w"> </span><span class="n">Action</span><span class="p">.</span><span class="n">haveFun</span><span class="p">);</span>
</pre></div>
</div>
<p>That places them above our four Foundation piles and centrally aligned with them. The first
Foundation pile happens to be aligned around the top-center of the screen, so the first button
is centred above it.</p>
</section>
<section id="anchors-and-co-ordinates">
<h3>Anchors and co-ordinates<a class="headerlink" href="#anchors-and-co-ordinates" title="Link to this heading">¶</a></h3>
<p>The expressions here and in the <code class="docutils literal notranslate"><span class="pre">addButton()</span></code> method may seem odd because the cards and piles all
have <code class="docutils literal notranslate"><span class="pre">Anchor.topLeft</span></code> but the buttons have <code class="docutils literal notranslate"><span class="pre">Anchor.center</span></code>. The <code class="docutils literal notranslate"><span class="pre">position</span></code> co-ordinates of a <code class="docutils literal notranslate"><span class="pre">Card</span></code>
are where its top-left corner goes, but the <code class="docutils literal notranslate"><span class="pre">position</span></code> co-ordinates of a <code class="docutils literal notranslate"><span class="pre">FlatButton</span></code> are where its
<em>center</em> goes and the various parts of a <code class="docutils literal notranslate"><span class="pre">FlatButton</span></code> are arranged (internally) around its center.
These examples can give us some insight into how co-ordinate systems work in Flame.</p>
</section>
<section id="the-deal-method">
<h3>The <code class="docutils literal notranslate"><span class="pre">deal()</span></code> method<a class="headerlink" href="#the-deal-method" title="Link to this heading">¶</a></h3>
<p>The last thing the KlondikeWorld’s <code class="docutils literal notranslate"><span class="pre">onLoad()</span></code> method does is call the <code class="docutils literal notranslate"><span class="pre">deal()</span></code> method to shuffle
and deal the cards. This method is now in the KlondikeWorld class and so are the <code class="docutils literal notranslate"><span class="pre">checkWin()</span></code> and
<code class="docutils literal notranslate"><span class="pre">letsCelebrate()</span></code> methods, but more about those later. The deal process is the same as before but
now includes some animation:</p>
<div class="highlight-dart notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">deal</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">assert</span><span class="p">(</span><span class="n">cards</span><span class="p">.</span><span class="n">length</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">52</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;There are </span><span class="si">${</span><span class="n">cards</span><span class="p">.</span><span class="n">length</span><span class="si">}</span><span class="s1"> cards: should be 52&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">action</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">Action</span><span class="p">.</span><span class="n">sameDeal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// New deal: change the Random Number Generator&#39;s seed.</span>
<span class="w">      </span><span class="n">game</span><span class="p">.</span><span class="n">seed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Random</span><span class="p">().</span><span class="n">nextInt</span><span class="p">(</span><span class="n">KlondikeGame</span><span class="p">.</span><span class="n">maxInt</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">action</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Action</span><span class="p">.</span><span class="n">changeDraw</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="n">klondikeDraw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">klondikeDraw</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">3</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="m">3</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// For the &quot;Same deal&quot; option, re-use the previous seed, else use a new one.</span>
<span class="w">    </span><span class="n">cards</span><span class="p">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">Random</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">seed</span><span class="p">));</span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">cardToDeal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cards</span><span class="p">.</span><span class="n">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">;</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">nMovingCards</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">7</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">7</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">card</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cards</span><span class="p">[</span><span class="n">cardToDeal</span><span class="o">--</span><span class="p">];</span>
<span class="w">        </span><span class="n">card</span><span class="p">.</span><span class="n">doMove</span><span class="p">(</span>
<span class="w">          </span><span class="n">tableauPiles</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">position</span><span class="p">,</span>
<span class="w">          </span><span class="nl">start:</span><span class="w"> </span><span class="n">nMovingCards</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">0.15</span><span class="p">,</span>
<span class="w">          </span><span class="nl">onComplete:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">tableauPiles</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">acquireCard</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="w">            </span><span class="n">nMovingCards</span><span class="o">--</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nMovingCards</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="kd">var</span><span class="w"> </span><span class="n">delayFactor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">;</span>
<span class="w">              </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">tableauPile</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">tableauPiles</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">delayFactor</span><span class="o">++</span><span class="p">;</span>
<span class="w">                </span><span class="n">tableauPile</span><span class="p">.</span><span class="n">flipTopCard</span><span class="p">(</span><span class="nl">start:</span><span class="w"> </span><span class="n">delayFactor</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">0.15</span><span class="p">);</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">},</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">        </span><span class="n">nMovingCards</span><span class="o">++</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">cardToDeal</span><span class="p">;</span><span class="w"> </span><span class="n">n</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">stock</span><span class="p">.</span><span class="n">acquireCard</span><span class="p">(</span><span class="n">cards</span><span class="p">[</span><span class="n">n</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
</pre></div>
</div>
<p>First we implement the <code class="docutils literal notranslate"><span class="pre">Action</span></code> value for this game. In the very first game, the KlondikeGame class
sets defaults of <code class="docutils literal notranslate"><span class="pre">Action.newDeal</span></code> and <code class="docutils literal notranslate"><span class="pre">klondikeDraw</span> <span class="pre">=</span> <span class="pre">1</span></code>, but after that the player can select an
action by pressing and releasing a button and KlondikeWorld saves it in KlondikeGame — or the player
wins the game, in which case <code class="docutils literal notranslate"><span class="pre">Action.newDeal</span></code> is selected and saved automatically. The action
usually generates and saves a new seed, but that is skipped if we have <code class="docutils literal notranslate"><span class="pre">Action.sameDeal</span></code>. Then we
shuffle the cards, using whatever <code class="docutils literal notranslate"><span class="pre">seed</span></code> applies.</p>
<p>The deal logic is the same as we used in Klondike Tutorial Step 4 and the animation is fairly easy.
We just use <code class="docutils literal notranslate"><span class="pre">card.doMove(</span></code> for each card, with a changing destination and an increasing <code class="docutils literal notranslate"><span class="pre">start:</span></code>
value, counting each moving card as it departs. For a few milliseconds after the loops terminate
<code class="docutils literal notranslate"><span class="pre">nMovingCards</span></code> will be at a maximum of 28 (i.e. 1 + 2 + 3 + 4 + 5 + 6 + 7) and the remaining 24
cards will go into a properly constructed Stock Pile.</p>
<p>Then cards will be arriving over the next second or so and a problem arises. The cards do not
necessarily arrive in the order they are sent from the Stock Pile area. If we start turning over
the last cards in the columns too soon, we might turn over the wrong card and mess up the deal. The
following printout of the deal shows how arrivals can get out of order. The <code class="docutils literal notranslate"><span class="pre">j</span></code> variable is the
Tableau Pile number and <code class="docutils literal notranslate"><span class="pre">i</span></code> is the card’s position in the pile. The King of Hearts for Pile 6 is
arriving before the Queen of Clubs that is the last card in Pile 5. And there are two more cards
to go in Pile 6.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">flutter: Move done, i 3, j 6, 6♠ 5 moving cards.</span>
<span class="go">flutter: Move done, i 4, j 5, 9♥ 4 moving cards.</span>
<span class="go">flutter: Move done, i 4, j 6, K♥ 3 moving cards.</span>
<span class="go">flutter: Move done, i 5, j 5, Q♣ 2 moving cards.</span>
<span class="go">flutter: Move done, i 5, j 6, 2♠ 1 moving cards.</span>
<span class="go">flutter: Move done, i 6, j 6, 10♠ 0 moving cards.</span>
<span class="go">flutter: Pile 0 [Q♦]</span>
<span class="go">flutter: Pile 1 [J♣, Q♥]</span>
<span class="go">flutter: Pile 2 [5♥, 5♦, J♦]</span>
<span class="go">flutter: Pile 3 [A♠, Q♠, A♥, 5♠]</span>
<span class="go">flutter: Pile 4 [8♦, 10♣, 7♥, 3♥, 4♥]</span>
<span class="go">flutter: Pile 5 [4♠, 8♣, 5♣, 2♥, 9♥, Q♣]</span>
<span class="go">flutter: Pile 6 [4♣, 3♦, K♦, 6♠, K♥, 2♠, 10♠]</span>
</pre></div>
</div>
<p>So we count off the cards in the <code class="docutils literal notranslate"><span class="pre">onComplete()</span></code> callback code as they arrive. Only when all 28 cards
have arrived do we start turning over the last card of each Tableau Pile. When the deal has been
completed our KlondikeWorld is also complete and ready for play.</p>
</section>
</section>
<section id="more-animations-of-moves">
<h2>More animations of moves<a class="headerlink" href="#more-animations-of-moves" title="Link to this heading">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">Card</span></code> class’s <code class="docutils literal notranslate"><span class="pre">doMove()</span></code> and <code class="docutils literal notranslate"><span class="pre">turnFaceUp()</span></code> methods have been combined into a doMoveAndFlip()
method, which is used to draw cards from the Stock Pile. The dropping of a card or cards onto a pile
after drag-and-drop also uses <code class="docutils literal notranslate"><span class="pre">doMove()</span></code> to settle the drop more gracefully. Finally, there is a
shortcut to auto-move a card onto its Foundation Pile if it is ready to go out. This adds
<code class="docutils literal notranslate"><span class="pre">TapCallbacks</span></code> to the <code class="docutils literal notranslate"><span class="pre">Card</span></code> class and an <code class="docutils literal notranslate"><span class="pre">onTapUp()</span></code> callback as follows:</p>
<div class="highlight-dart notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="n">onTapUp</span><span class="p">(</span><span class="n">TapUpEvent</span><span class="w"> </span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isFaceUp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">final</span><span class="w"> </span><span class="n">suitIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">suit</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">foundations</span><span class="p">[</span><span class="n">suitIndex</span><span class="p">].</span><span class="n">canAcceptCard</span><span class="p">(</span><span class="k">this</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pile</span><span class="o">!</span><span class="p">.</span><span class="n">removeCard</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<span class="w">        </span><span class="n">doMove</span><span class="p">(</span>
<span class="w">          </span><span class="n">game</span><span class="p">.</span><span class="n">foundations</span><span class="p">[</span><span class="n">suitIndex</span><span class="p">].</span><span class="n">position</span><span class="p">,</span>
<span class="w">          </span><span class="nl">onComplete:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">game</span><span class="p">.</span><span class="n">foundations</span><span class="p">[</span><span class="n">suitIndex</span><span class="p">].</span><span class="n">acquireCard</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<span class="w">          </span><span class="p">},</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pile</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">StockPile</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">game</span><span class="p">.</span><span class="n">stock</span><span class="p">.</span><span class="n">onTapUp</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
</pre></div>
</div>
<p>If a card is ready to go out, just tap on it and it will move automatically to the correct
Foundation Pile for its suit. This saves a load of dragging-and-dropping when you are close to
winning the game! There is nothing new in the above code, except that if you tap the top card of
the Stock Pile, the <code class="docutils literal notranslate"><span class="pre">Card</span></code> object receives the tap first and forwards it on to the <code class="docutils literal notranslate"><span class="pre">stock</span></code> object.</p>
</section>
<section id="a-graphics-glitch">
<h2>A graphics glitch<a class="headerlink" href="#a-graphics-glitch" title="Link to this heading">¶</a></h2>
<p>If you moved multiple cards from one Tableau Pile to another, the internal code of the <code class="docutils literal notranslate"><span class="pre">TableauPile</span></code>
class would formerly (in Tutorial Step 4) move the cards into place abruptly, as soon as the
drag-and-drop ended. In the new code (Step 5), drags and drops use essentially the same code as
before, so it is tempting to get that code to do a multi-card move as a series of animated moves
each completing with an <code class="docutils literal notranslate"><span class="pre">acquireCard</span></code> call. But this caused some ugly graphics glitches. It
appears they were due to <code class="docutils literal notranslate"><span class="pre">acquireCard</span></code> also calling the <code class="docutils literal notranslate"><span class="pre">layoutCards()</span></code> method of <code class="docutils literal notranslate"><span class="pre">TableauPile</span></code> and
instantly re-arranging all the cards in the pile, every time a card was acquired. The problem has
been solved (with some difficulty as it turned out), by adding a <code class="docutils literal notranslate"><span class="pre">dropCards</span></code> method to
<code class="docutils literal notranslate"><span class="pre">TableauPile</span></code>, which mimics some of the existing actions while dovetailing some card animations
in as well.</p>
<p>The lesson to be learned is that it is worth giving some attention to animation and time-dependent
concerns at Game Design time. When was that? Back in Klondike Tutorial Step 1 Preparation and
Step 2 Scaffolding.</p>
</section>
<section id="winning-the-game">
<h2>Winning the game<a class="headerlink" href="#winning-the-game" title="Link to this heading">¶</a></h2>
<p>You win the game when all cards in all suits, Ace to King, have been moved to the Foundation Piles,
13 cards in each pile. The game now has code to recognize that event — an <code class="docutils literal notranslate"><span class="pre">isFull</span></code> test added to
the <code class="docutils literal notranslate"><span class="pre">FoundationPile</span></code>’s <code class="docutils literal notranslate"><span class="pre">acquireCard()</span></code> method, a callback to <code class="docutils literal notranslate"><span class="pre">KlondikeWorld</span></code> and a test as
to whether all four Foundations are full. Here is the code:</p>
<div class="highlight-dart notranslate"><div class="highlight"><pre><span></span><span class="kd">class</span><span class="w"> </span><span class="nc">FoundationPile</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">PositionComponent</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Pile</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">FoundationPile</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">intSuit</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="n">checkWin</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="k">super</span><span class="p">.</span><span class="n">position</span><span class="p">})</span>
<span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="n">suit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Suit</span><span class="p">.</span><span class="n">fromInt</span><span class="p">(</span><span class="n">intSuit</span><span class="p">),</span>
<span class="w">        </span><span class="k">super</span><span class="p">(</span><span class="nl">size:</span><span class="w"> </span><span class="n">KlondikeGame</span><span class="p">.</span><span class="n">cardSize</span><span class="p">);</span>

<span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="n">VoidCallback</span><span class="w"> </span><span class="n">checkWin</span><span class="p">;</span>

<span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="n">Suit</span><span class="w"> </span><span class="n">suit</span><span class="p">;</span>
<span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Card</span><span class="o">&gt;</span><span class="w"> </span><span class="n">_cards</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">  </span><span class="c1">//#region Pile API</span>

<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="kd">get</span><span class="w"> </span><span class="n">isFull</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">_cards</span><span class="p">.</span><span class="n">length</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">13</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-dart notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">acquireCard</span><span class="p">(</span><span class="n">Card</span><span class="w"> </span><span class="n">card</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">assert</span><span class="p">(</span><span class="n">card</span><span class="p">.</span><span class="n">isFaceUp</span><span class="p">);</span>
<span class="w">    </span><span class="n">card</span><span class="p">.</span><span class="n">position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">position</span><span class="p">;</span>
<span class="w">    </span><span class="n">card</span><span class="p">.</span><span class="n">priority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_cards</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
<span class="w">    </span><span class="n">card</span><span class="p">.</span><span class="n">pile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">;</span>
<span class="w">    </span><span class="n">_cards</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isFull</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">checkWin</span><span class="p">();</span><span class="w"> </span><span class="c1">// Get KlondikeWorld to check all FoundationPiles.</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
</pre></div>
</div>
<div class="highlight-dart notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">checkWin</span><span class="p">()</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">nComplete</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">foundations</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">isFull</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">nComplete</span><span class="o">++</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nComplete</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">foundations</span><span class="p">.</span><span class="n">length</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">letsCelebrate</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
</pre></div>
</div>
<p>It is often possible to calculate whether you can win from a given position of the cards in a
Klondike game, or could have won but missed a vital move. It is frequently possible to calculate
whether the initial deal is winnable: a percentage of Klondike deals are not. But all that is far
beyond the scope of this Tutorial, so for now it is up to the player to work out whether to keep
playing and try to win — or give up and press one of the buttons.</p>
</section>
<section id="ending-a-game-and-re-starting-it">
<h2>Ending a game and re-starting it<a class="headerlink" href="#ending-a-game-and-re-starting-it" title="Link to this heading">¶</a></h2>
<p>A game ends either after the player wins or they press and release one of the buttons. At that
point the KlondikeGame class must hold all the data needed to start a new game, namely an <code class="docutils literal notranslate"><span class="pre">Action</span></code>
value, a <code class="docutils literal notranslate"><span class="pre">klondikeDraw</span></code> value (1 or 3) and a <code class="docutils literal notranslate"><span class="pre">seed</span></code> from the previous game. Each button has an
<code class="docutils literal notranslate"><span class="pre">onReleased:</span></code> callback provided by the <code class="docutils literal notranslate"><span class="pre">addButton()</span></code> method in KlondikeWorld, with code as follows:</p>
<div class="highlight-dart notranslate"><div class="highlight"><pre><span></span><span class="w">      </span><span class="nl">onReleased:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">action</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Action</span><span class="p">.</span><span class="n">haveFun</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="c1">// Shortcut to the &quot;win&quot; sequence, for Tutorial purposes only.</span>
<span class="w">          </span><span class="n">letsCelebrate</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="c1">// Restart with a new deal or the same deal as before.</span>
<span class="w">          </span><span class="n">game</span><span class="p">.</span><span class="n">action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">action</span><span class="p">;</span>
<span class="w">          </span><span class="n">game</span><span class="p">.</span><span class="n">world</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KlondikeWorld</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">},</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">letsCelebrate()</span></code> method is normally invoked only when the player wins. The functions of the
other three buttons are to set the <code class="docutils literal notranslate"><span class="pre">Action</span></code> value in KlondikeGame and to set <code class="docutils literal notranslate"><span class="pre">world</span></code> in <code class="docutils literal notranslate"><span class="pre">FlameGame</span></code>
to refer to a new KlondikeWorld, thus replacing the current one and leaving the former
KlondikeWorld’s storage to be disposed of by Garbage Collect. <code class="docutils literal notranslate"><span class="pre">FlameGame</span></code> will continue on to
trigger KlondikeWorld’s <code class="docutils literal notranslate"><span class="pre">onLoad()</span></code> method.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">letsCelebrate()</span></code> method ends with similar code, but forces a new deal:</p>
<div class="highlight-dart notranslate"><div class="highlight"><pre><span></span><span class="w">              </span><span class="n">game</span><span class="p">.</span><span class="n">action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Action</span><span class="p">.</span><span class="n">newDeal</span><span class="p">;</span>
<span class="w">              </span><span class="n">game</span><span class="p">.</span><span class="n">world</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KlondikeWorld</span><span class="p">();</span>
</pre></div>
</div>
</section>
<section id="the-have-fun-button">
<h2>The <code class="docutils literal notranslate"><span class="pre">Have</span> <span class="pre">fun</span></code> button<a class="headerlink" href="#the-have-fun-button" title="Link to this heading">¶</a></h2>
<p>When you win the Klondike Game, the <code class="docutils literal notranslate"><span class="pre">letsCelebrate()</span></code> method puts on a little display. To save you
having to play and win a whole game before you see it — <strong>and</strong> to test the method, we have
provided the <code class="docutils literal notranslate"><span class="pre">Have</span> <span class="pre">fun</span></code> button. Of course a real game could not have such a button…</p>
<p>Well, this is it! The game is now more playable.</p>
<p>We could do more, but this game <strong>is</strong> a Tutorial above all else. Press the buttons below to see
what the final code looks like, or to play it live.</p>
<p>But it is also time to have a look at the Ember Tutorial!</p>
</section>
</section>


    </div>
    <div class="copyright">
      The content on this page is licensed under the <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0 License</a>,
      and code samples under the <a href="https://raw.githubusercontent.com/flame-engine/flame/main/LICENSE">MIT License</a>.
    </div>
    <div class="prev-next-area">
      <a class="left-prev" id="prev-link" href="step4.html" title="previous page">
        <i class="fa fa-angle-left"></i>
        <div class="prev-next-info">
          <p class="prev-next-subtitle">Previous:</p>
          <p class="prev-next-title">4. Gameplay</p>
        </div>
      </a>
      <div class='expander'></div>
      <a class="right-next" id="next-link" href="../platformer/platformer.html" title="next page">
        <div class="prev-next-info">
          <p class="prev-next-subtitle">Next:</p>
          <p class="prev-next-title">Ember Quest Game Tutorial</p>
        </div>
        <i class="fa fa-angle-right"></i>
      </a>
    </div>
  </div>

  <div class="sidebar-right">
    
    <div class="nav-right" role="navigation" aria-label="table of contents">
      <div id='toc-local' class='list-group'>
 <div class='header'><i class='fa fa-list'></i> Contents</div>
  <a href='#the-klondike-draw' class='list-group-item level-1'>The Klondike draw</a>
  <a href='#making-cards-move' class='list-group-item level-1'>Making cards move</a>
  <a href='#animating-a-card-flip' class='list-group-item level-1'>Animating a card-flip</a>
  <a href='#model-and-view' class='list-group-item level-1'>Model and View</a>
  <a href='#ending-and-restarting-the-game' class='list-group-item level-1'>Ending and restarting the game</a>
  <a href='#a-new-world' class='list-group-item level-1'>A New World</a>
  <a href='#start-and-restart-actions' class='list-group-item level-2'>Start and restart actions</a>
  <a href='#a-stripped-down-klondikegame-class' class='list-group-item level-2'>A stripped-down KlondikeGame class</a>
  <a href='#using-a-random-number-generator-seed' class='list-group-item level-2'>Using a Random Number Generator seed</a>
  <a href='#introducing-the-new-klondikeworld-class' class='list-group-item level-2'>Introducing the new KlondikeWorld class</a>
  <a href='#buttons' class='list-group-item level-2'>Buttons</a>
  <a href='#anchors-and-co-ordinates' class='list-group-item level-2'>Anchors and co-ordinates</a>
  <a href='#the-deal-method' class='list-group-item level-2'>The deal() method</a>
  <a href='#more-animations-of-moves' class='list-group-item level-1'>More animations of moves</a>
  <a href='#a-graphics-glitch' class='list-group-item level-1'>A graphics glitch</a>
  <a href='#winning-the-game' class='list-group-item level-1'>Winning the game</a>
  <a href='#ending-a-game-and-re-starting-it' class='list-group-item level-1'>Ending a game and re-starting it</a>
  <a href='#the-have-fun-button' class='list-group-item level-1'>The Have fun button</a>
</div>

    </div>
  </div>

  <div class="expander"></div>
</div>




</body>
</html>